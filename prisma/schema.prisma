generator client {
  provider     = "prisma-client"
  output       = "../app/generated/prisma"
  moduleFormat = "esm"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String        @id
  name          String
  email         String
  emailVerified Boolean       @default(false) @map("email_verified")
  image         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  isAnonymous   Boolean       @default(false) @map("is_anonymous")
  sessions      Session[]
  accounts      Account[]
  apiUsageLogs  ApiUsageLog[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime @map("expires_at")
  token     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                     String    @id
  accountId              String    @map("account_id")
  providerId             String    @map("provider_id")
  userId                 String    @map("user_id")
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken            String?   @map("access_token")
  refreshToken           String?   @map("refresh_token")
  idToken                String?   @map("id_token")
  accessTokenExpiresAt   DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt  DateTime? @map("refresh_token_expires_at")
  scope                  String?
  password               String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([identifier])
  @@map("verification")
}

/// API利用ログ（コスト分析用）
model ApiUsageLog {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now()) @map("created_at")
  /// ユーザーID（nullable: 匿名ユーザーや認証前の利用も記録可能）
  userId       String?  @map("user_id")
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  /// 操作種別: "slide_analysis" | "image_generation"
  operation    String
  /// 使用モデル: "gemini-3-pro-preview" | "gemini-2.5-flash" など
  model        String
  /// 入力トークン数
  inputTokens  Int      @map("input_tokens")
  /// 出力トークン数
  outputTokens Int      @map("output_tokens")
  /// コスト（USD）
  costUsd      Float    @map("cost_usd")
  /// コスト（JPY）
  costJpy      Float    @map("cost_jpy")
  /// 為替レート
  exchangeRate Float    @map("exchange_rate")
  /// 追加メタデータ（JSON）
  metadata     String?

  @@index([createdAt])
  @@index([operation])
  @@index([userId])
  @@map("api_usage_log")
}
