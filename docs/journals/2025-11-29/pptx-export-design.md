# 単体スライドPPTXエクスポート設計

## 背景と目的

SlideCraftのエディタ画面では、AIが生成したスライド画像を選択・編集できる。現在はPDF形式での全スライド一括エクスポートのみ対応しているが、PowerPointで個別スライドを編集したいケースがある。

references/slide-extractorで実験した手法を採用する。LLMでスライド画像を解析し、テキスト要素とグラフィック領域を構造化データとして抽出、PptxGenJSで編集可能なPowerPointファイルを生成する。SVGを中間形式として使う当初案は、slide-extractorの実験結果から、構造化JSONを直接PPTXに変換するほうが精度が高いことが判明したため変更する。

## 全体アーキテクチャ

処理は3つのフェーズに分かれる。

第1フェーズはLLMによる画像解析である。スライド画像をGemini APIに送信し、テキスト要素（内容、位置、サイズ、フォント、色、役割）とグラフィック領域（位置、サイズ、説明）を構造化データとして抽出する。座標とサイズはすべて画像全体に対するパーセンテージ（0-100%）で指定させる。これによりモデルに依存しない汎用的な位置指定が可能となる。

第2フェーズはグラフィック領域の切り出しである。解析結果のグラフィック領域をもとに、元画像から該当部分をPNG画像として切り出す。ブラウザ環境ではCanvasを使用して切り出しを行う。

第3フェーズはPPTX生成とダウンロードである。解析結果のテキスト要素をaddTextで、切り出したグラフィック画像をaddImageで配置する。パーセンテージ座標をインチ座標に変換してPowerPointのスライドに配置する。

## 技術選定

LLMにはGemini APIを使用する。slide-extractorの実験でGemini 2.5 Flashが精度92/100でコスト効率が最も高いことが判明した。Gemini 3 Proは精度98/100だがコストが高い。SlideCraftではGemini 2.5 Flashをデフォルトとし、高精度が必要な場合はGemini 3 Proを選択できるようにする。

Gemini APIの呼び出しはクライアントサイドから直接行う。既存のスライド画像生成と同様に@google/genaiパッケージを使用する。ユーザーが自身のAPIキーをブラウザのlocalStorageに保存し、クライアントから直接APIを呼び出す方式とする。これによりサーバーにAPIキーを預けることなく、ユーザー自身がAPIキーを管理できる。

構造化データの抽出にはGemini APIのgenerateContent関数を使用し、JSON形式で出力するようプロンプトで指示する。レスポンスをZodスキーマでパースして型安全性を確保する。

PPTXの生成にはPptxGenJSを使用する。slide-extractorで実証済みの手法をそのまま適用できる。

## データ構造

slide-extractorで定義済みのスキーマをベースとする。

TextElementはテキスト要素を表す。contentはテキスト内容、x/y/width/heightは位置とサイズ（0-100%）、fontSizeはポイント単位、fontWeightはlight/normal/medium/bold/blackの5段階、fontStyleはserif（明朝体）またはsans-serif（ゴシック体）、colorは16進数、alignはleft/center/right、roleはtitle/subtitle/body/footer/logoのいずれかである。

GraphicRegionはグラフィック領域を表す。descriptionは領域の説明、x/y/width/heightは位置とサイズ（0-100%）である。

SlideAnalysisは解析結果全体を表す。backgroundColorは背景色、textElementsはテキスト要素の配列、graphicRegionsはグラフィック領域の配列、slideTitleはスライドタイトルである。

## LLMプロンプト設計

slide-extractorで検証済みのプロンプトを使用する。

システムプロンプトでは、スライド画像を解析して編集可能なPowerPointに変換するためのデータを抽出するタスクであることを説明する。テキスト要素の検出では、すべてのテキストを識別し、位置とサイズをパーセンテージで推定する。フォントスタイルはserifとsans-serifを区別する。serifは文字の端に装飾があり縦線が太く横線が細い伝統的な印象、sans-serifは装飾がなく線の太さが均一でモダンな印象と説明する。フォントの太さは同じスライド内の他のテキストと比較して相対的に判断させる。

ロゴの扱いについて明示的に指示する。ロゴはテキスト要素かグラフィック領域のどちらか一方のみに含める。グラフィカルなロゴ（アイコン、装飾、視覚的デザインがあるもの）はgraphicRegionsに、プレーンテキストのロゴはtextElementsにrole=logoとして含める。

テキストボックスのサイズ指定について重要な指示を含める。テキストが1文字でも溢れて改行されないよう、widthは実際のテキスト幅より10-15%程度余裕を持たせる。日本語テキストは文字幅の推定が難しいため特に余裕を持たせる。

## データフロー

ユーザーがエディタ画面でPPTXエクスポートボタンをクリックすると、エクスポートダイアログが開く。現在のスライド画像がプレビュー表示され、モデル選択（Gemini 2.5 Flash/Gemini 3 Pro）と「解析開始」ボタンが表示される。

解析開始ボタンをクリックすると、localStorageからAPIキーを取得し、スライド画像をBase64に変換してクライアントサイドから直接Gemini APIを呼び出す。JSON形式で構造化データを取得し、Zodスキーマでパースする。解析結果をテキスト要素とグラフィック領域のプレビューとして表示する。

ユーザーがプレビューを確認し、「PPTXダウンロード」ボタンをクリックすると、クライアントサイドでグラフィック領域を元画像から切り出す。PptxGenJSでテキストとグラフィックを配置してPPTXを生成する。ブラウザでダウンロードを発火する。

## ファイル構成

新規ファイルは4つ作成する。

app/lib/slide-analyzer.client.tsはスライド解析処理である。@google/genaiを使用してGemini APIを呼び出し、画像からSlideAnalysisを抽出する。既存のgemini-api.client.tsと同様のパターンでクライアントサイドから直接APIを呼び出す。

app/lib/slide-analysis.tsは解析関連の型定義とZodスキーマである。slide-extractorのtypes.tsをベースに必要な部分を移植する。

app/lib/graphic-extractor.client.tsはグラフィック領域の切り出し処理である。Canvas APIを使用して画像から指定領域を切り出しPNG Blobとして返す。

app/lib/pptx-generator.client.tsはPPTX生成処理である。SlideAnalysisと切り出したグラフィック画像からPPTXを生成する。slide-extractorのgenerator.tsをブラウザ向けに移植する。

app/routes/\_app/projects/$projectId/edit/+/components/pptx-export-dialog.tsxはエクスポート用のダイアログコンポーネントである。デザインポリシーに従いDialogを使用する。

既存ファイルの修正箇所は1つである。app/routes/\_app/projects/$projectId/edit/+/editor-actions.tsxにPPTXエクスポートボタンを追加し、ダイアログを開くトリガーとする。

## 座標変換

パーセンテージ座標からPowerPointのインチ座標への変換を行う。PowerPointの16:9スライドは10インチ×5.625インチである。変換式は以下の通り。

x（インチ）= (x% / 100) × 10
y（インチ）= (y% / 100) × 5.625
width（インチ）= (width% / 100) × 10
height（インチ）= (height% / 100) × 5.625

フォントサイズは画像の高さに応じてスケーリングする。標準的なスライドの高さを540pxと仮定し、scaleFactor = 540 / 実際の画像高さ でスケーリング係数を算出する。

## フォント選択

fontStyleとfontWeightに基づいてフォントを選択する。serifの場合はNoto Serif JP、sans-serifの場合はNoto Sans JPを使用する。fontWeightがboldまたはblackの場合はboldフラグをtrueにする。role=logoの場合は互換性のためArialを使用する。

ユーザー環境にNotoフォントがインストールされていない場合に備え、フォールバックを設定する。serifはNoto Serif JP、游明朝、MS 明朝、Hiragino Mincho ProNの順でフォールバックする。sans-serifはNoto Sans JP、游ゴシック、メイリオ、Hiragino Kaku Gothic ProNの順でフォールバックする。PptxGenJSのfontFace属性には優先フォントのみを指定し、フォールバックはPowerPoint側の機能に委ねる。

## 画像サイズ取得

OPFSから読み込んだBlobから画像サイズを取得するため、Imageオブジェクトを使用する。BlobからObject URLを生成し、Imageのsrcに設定してonloadイベントでnaturalWidthとnaturalHeightを取得する。取得後はObject URLをrevokeしてメモリを解放する。この画像サイズはフォントサイズスケーリングとグラフィック切り出しの座標計算に使用する。

## グラフィック切り出し

ブラウザ環境ではCanvas APIを使用してグラフィック領域を切り出す。パーセンテージ座標から実際のピクセル座標を算出し、drawImageで指定領域を切り出してtoBlobでPNG Blobを取得する。境界チェックを行い、画像サイズを超える座標は補正する。

## エラーハンドリング

Gemini API呼び出しが失敗した場合はエラーメッセージを表示し、リトライボタンを提供する。APIキーエラー、レート制限エラー、ネットワークエラーを区別して適切なメッセージを表示する。

generateContentはJSON形式で出力するようプロンプトで指示するが、不正なJSONが返る可能性がある。JSONパースエラーが発生した場合は最大2回リトライする。2回リトライしても失敗する場合はエラーを表示する。Zodバリデーションに失敗した場合も同様にリトライする。

グラフィック切り出しで境界外参照が発生した場合は該当領域をスキップし、処理を継続する。PPTX生成に失敗した場合はエラーを表示する。

## キャンセル機構

解析中にユーザーがダイアログを閉じた場合、API呼び出しをキャンセルする。AbortControllerを使用し、ダイアログのクローズ時にabortを呼び出す。キャンセルされた場合はエラーとして扱わず、静かに処理を終了する。

## UI設計

エクスポートダイアログは3つの状態を持つ。初期状態では元のスライド画像のプレビュー、モデル選択ドロップダウン、「解析開始」ボタンを表示する。解析中状態ではLoader2アイコンとともに「解析中...」メッセージを表示する。完了状態では解析結果のプレビューと「PPTXダウンロード」ボタンを表示する。

モデル選択ドロップダウンには概算コストを併記する。「Gemini 2.5 Flash（約$0.02/回）」「Gemini 3 Pro（約$0.03/回）」のように表示し、ユーザーがコストを意識して選択できるようにする。

完了状態のプレビューでは、テキスト要素の境界ボックスを青色の半透明矩形でオーバーレイ表示する。グラフィック領域は緑色の半透明矩形で表示する。これによりLLMがどの領域をテキスト/グラフィックとして認識したかをユーザーが確認できる。

ダイアログの幅は最大800pxとし、プレビュー領域を大きく確保する。ESCキーまたはオーバーレイクリックでダイアログを閉じられるようにする。ダイアログを閉じる際に解析中であればAbortControllerでAPI呼び出しをキャンセルする。

## 依存関係

pptxgenjsパッケージを追加する。バージョンは4.0.1を使用する。

@google/genaiパッケージはすでにプロジェクトに含まれているため追加不要である。APIキーはユーザーがlocalStorageに保存し、クライアントから直接使用する。

zodパッケージはすでにプロジェクトに含まれているため追加不要である。

## モデル比較

slide-extractorの実験結果に基づくモデル選定指針を示す。

Gemini 2.5 Flashは精度92/100、コスト$0.016/スライドで、コスト効率が最も高い。大量処理や通常利用に推奨する。

Gemini 3 Proは精度98/100、コスト$0.026/スライドで、精度が最も高い。高品質が求められる場合に推奨する。

## 将来の拡張

検証ループの導入を検討する。slide-extractorでは解析→検証→修正のループで精度を向上させている。初回リリースではシンプルな1回解析とし、精度に問題があれば検証ループを追加する。

複数スライドの一括PPTXエクスポートを検討する。各スライドを順次LLMで処理し、1つのPPTXファイルにまとめる。処理時間が長くなるため、進捗表示とキャンセル機能が必要となる。

解析結果の手動編集機能を検討する。テキスト内容の修正、位置の微調整、フォントサイズの変更などをダイアログ内で行えるようにする。
